%SB=100MVA,UB=12.66kV,IEEE-33 Bus,Distflow SOC-ACOPF
%考虑重构，全天拓扑不变
clear
clc
tic
%网络数据，标幺值
Pload=[0.00100000000000000;0.000900000000000000;0.00120000000000000;0.000600000000000000;0.000600000000000000;0.00200000000000000;0.00200000000000000;0.000600000000000000;0.000600000000000000;0.000450000000000000;0.000600000000000000;0.000600000000000000;0.00120000000000000;0.000600000000000000;0.000600000000000000;0.000600000000000000;0.000900000000000000;0.000900000000000000;0.000900000000000000;0.000900000000000000;0.000900000000000000;0.000900000000000000;0.00420000000000000;0.00420000000000000;0.000600000000000000;0.000600000000000000;0.000600000000000000;0.00120000000000000;0.00200000000000000;0.00150000000000000;0.00210000000000000;0.000600000000000000;0];
Qload=[0.000600000000000000;0.000400000000000000;0.000800000000000000;0.000300000000000000;0.000200000000000000;0.00100000000000000;0.00100000000000000;0.000200000000000000;0.000200000000000000;0.000300000000000000;0.000350000000000000;0.000350000000000000;0.000800000000000000;0.000100000000000000;0.000200000000000000;0.000200000000000000;0.000400000000000000;0.000400000000000000;0.000400000000000000;0.000400000000000000;0.000400000000000000;0.000500000000000000;0.00200000000000000;0.00200000000000000;0.000250000000000000;0.000250000000000000;0.000200000000000000;0.000700000000000000;0.00600000000000000;0.000700000000000000;0.00100000000000000;0.000400000000000000;0];
Line=[33.0000000000000 + 0.00000000000000i,1.00000000000000 + 0.00000000000000i,0.0922000000000000 + 0.0470000000000000i;1.00000000000000 + 0.00000000000000i,2.00000000000000 + 0.00000000000000i,0.493000000000000 + 0.251100000000000i;2.00000000000000 + 0.00000000000000i,3.00000000000000 + 0.00000000000000i,0.366000000000000 + 0.186400000000000i;3.00000000000000 + 0.00000000000000i,4.00000000000000 + 0.00000000000000i,0.381100000000000 + 0.194100000000000i;4.00000000000000 + 0.00000000000000i,5.00000000000000 + 0.00000000000000i,0.819000000000000 + 0.707000000000000i;5.00000000000000 + 0.00000000000000i,6.00000000000000 + 0.00000000000000i,0.187200000000000 + 0.618800000000000i;6.00000000000000 + 0.00000000000000i,7.00000000000000 + 0.00000000000000i,0.711400000000000 + 0.235100000000000i;7.00000000000000 + 0.00000000000000i,8.00000000000000 + 0.00000000000000i,1.03000000000000 + 0.740000000000000i;8.00000000000000 + 0.00000000000000i,9.00000000000000 + 0.00000000000000i,1.04400000000000 + 0.740000000000000i;9.00000000000000 + 0.00000000000000i,10.0000000000000 + 0.00000000000000i,0.196600000000000 + 0.0650000000000000i;10.0000000000000 + 0.00000000000000i,11.0000000000000 + 0.00000000000000i,0.374400000000000 + 0.123800000000000i;11.0000000000000 + 0.00000000000000i,12.0000000000000 + 0.00000000000000i,1.46800000000000 + 1.15500000000000i;12.0000000000000 + 0.00000000000000i,13.0000000000000 + 0.00000000000000i,0.541600000000000 + 0.712900000000000i;13.0000000000000 + 0.00000000000000i,14.0000000000000 + 0.00000000000000i,0.591000000000000 + 0.526000000000000i;14.0000000000000 + 0.00000000000000i,15.0000000000000 + 0.00000000000000i,0.746300000000000 + 0.545000000000000i;15.0000000000000 + 0.00000000000000i,16.0000000000000 + 0.00000000000000i,1.28900000000000 + 1.72100000000000i;16.0000000000000 + 0.00000000000000i,17.0000000000000 + 0.00000000000000i,0.372000000000000 + 0.574000000000000i;1.00000000000000 + 0.00000000000000i,18.0000000000000 + 0.00000000000000i,0.164000000000000 + 0.156500000000000i;18.0000000000000 + 0.00000000000000i,19.0000000000000 + 0.00000000000000i,1.50420000000000 + 1.35540000000000i;19.0000000000000 + 0.00000000000000i,20.0000000000000 + 0.00000000000000i,0.409500000000000 + 0.478400000000000i;20.0000000000000 + 0.00000000000000i,21.0000000000000 + 0.00000000000000i,0.708900000000000 + 0.937300000000000i;2.00000000000000 + 0.00000000000000i,22.0000000000000 + 0.00000000000000i,0.451200000000000 + 0.308300000000000i;22.0000000000000 + 0.00000000000000i,23.0000000000000 + 0.00000000000000i,0.898000000000000 + 0.709100000000000i;23.0000000000000 + 0.00000000000000i,24.0000000000000 + 0.00000000000000i,0.896000000000000 + 0.701100000000000i;5.00000000000000 + 0.00000000000000i,25.0000000000000 + 0.00000000000000i,0.203000000000000 + 0.103400000000000i;25.0000000000000 + 0.00000000000000i,26.0000000000000 + 0.00000000000000i,0.284200000000000 + 0.144700000000000i;26.0000000000000 + 0.00000000000000i,27.0000000000000 + 0.00000000000000i,1.05900000000000 + 0.933700000000000i;27.0000000000000 + 0.00000000000000i,28.0000000000000 + 0.00000000000000i,0.804200000000000 + 0.700600000000000i;28.0000000000000 + 0.00000000000000i,29.0000000000000 + 0.00000000000000i,0.507500000000000 + 0.258500000000000i;29.0000000000000 + 0.00000000000000i,30.0000000000000 + 0.00000000000000i,0.974400000000000 + 0.963000000000000i;30.0000000000000 + 0.00000000000000i,31.0000000000000 + 0.00000000000000i,0.310500000000000 + 0.361900000000000i;31.0000000000000 + 0.00000000000000i,32.0000000000000 + 0.00000000000000i,0.341000000000000 + 0.536200000000000i;7.00000000000000 + 0.00000000000000i,20.0000000000000 + 0.00000000000000i,2.00000000000000 + 2.00000000000000i;8.00000000000000 + 0.00000000000000i,14.0000000000000 + 0.00000000000000i,2.00000000000000 + 2.00000000000000i;11.0000000000000 + 0.00000000000000i,21.0000000000000 + 0.00000000000000i,2.00000000000000 + 2.00000000000000i;17.0000000000000 + 0.00000000000000i,32.0000000000000 + 0.00000000000000i,0.500000000000000 + 0.500000000000000i;24.0000000000000 + 0.00000000000000i,28.0000000000000 + 0.00000000000000i,0.500000000000000 + 0.500000000000000i];
Line(:,3)=Line(:,3)*100/(12.66^2);
r=real(Line(:,3));
x=imag(Line(:,3));
father=zeros(33,37);son=zeros(33,37);
for i=1:32
    father(i,i)=1;
end
father(20,33)=1;father(14,34)=1;father(21,35)=1;father(32,36)=1;father(28,37)=1;
for i=[1:16,18:20,22:23,25:31]
    son(i,i+1)=1;
end
son(1,18)=1;son(2,22)=1;son(5,25)=1;son(33,1)=1;son(7,33)=1;son(8,34)=1;son(11,35)=1;son(17,36)=1;son(24,37)=1;
Umax=[1.07*1.07*ones(32,1);1.05*1.05];
Umin=[0.93*0.93*ones(32,1);1.05*1.05];
Pgmax=[zeros(32,1);1];
Qgmax=[zeros(32,1);1];
%定义变量
P=sdpvar(37,1);%线路有功
Q=sdpvar(37,1);%线路无功
U=sdpvar(33,1);%电压的平方
I=sdpvar(37,1);%电流的平方
Pg=[zeros(32,1);sdpvar];%发电机有功
Qg=[zeros(32,1);sdpvar];%发电机无功
AA=binvar(37,1);%网架结构
A0=[ones(32,1);zeros(5,1)];%初始拓扑
assign(AA,A0);
Pin=-father*P+father*(I.*r)+son*P;%节点注入有功
Qin=-father*Q+father*(I.*x)+son*Q;%节点注入无功
P_tree=sdpvar(37,1);%虚拟有功
Pin_tree=-father*P_tree+son*P_tree;%虚拟节点注入有功
Ploss_total=sum(I.*r);%目标函数，网损最小
%约束条件
C1=[sum(AA)==32,U>=Umin,U<=Umax,Pg>=-Pgmax,Pg<=Pgmax,Qg>=-Qgmax,Qg<=Qgmax,I>=0,I<=0.11*AA,-AA<=P_tree<=AA,-0.11*AA<=P<=0.11*AA,-0.11*AA<=Q<=0.11*AA];%边界约束
C2=[Pin+Pload-Pg==0,Pin_tree(1:32)+0.01==0];%有功KCL约束
C3=[Qin+Qload-Qg==0];%无功KCL约束
C4=[-(1.07*1.07-0.93*0.93)*(1-AA)<=-U(Line(:,2),:)+U(Line(:,1),:)-2*r.*P-2*x.*Q+(r.^2+x.^2).*I<=(1.07*1.07-0.93*0.93)*(1-AA)];%电压降落约束
C=[C1,C2,C3,C4];
toc%建模时间
ops=sdpsettings('solver','gurobi','usex0',1);
[model,recoverymodel,diagnostic,internalmodel] = export(C,Ploss_total,ops);%得到除去P^2+Q^2=UI的约束
params.Nonconvex=2;%启动gurobi非线性求解器
params.FeasibilityTol=1e-9;%由于gurobi采取的是双层模型，因此可行性步长应尽可能小
params.IntFeasTol=1e-9;%由于gurobi对非线性模型采用的是外嵌分支定界算法，相当于求解MIP问题，因此整数可行性要足够精确
params.Threads=8;%并行计算，8线程
L=length(model.obj);%决策变量数
%下面定义P^2+Q^2=UI的约束,模型为sum(Qval*x(Qrow)*x(Qcol))+q*x=rhs
    for j=1:37
        model.quadcon(j).Qrow=[j,j+37,Line(j,1)+37*2];%P,Q,Uj
        model.quadcon(j).Qcol=[j,j+37,j+37*2+33];%P,Q,I
        model.quadcon(j).Qval=[1,1,-1];%P^2+Q^2-UI
        model.quadcon(j).q=sparse(L,1);
        model.quadcon(j).rhs=0;
        model.quadcon(j).sense='=';%严格等号
    end
result=gurobi(model,params);
assign(recover(recoverymodel.used_variables),result.x(1:L));%对决策变量赋值
toc%求解时间
Ploss_total=100*double(result.objval)
%0.1254,21.36秒
